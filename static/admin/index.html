<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!--
    Content Security Policy:
    Adjust as needed. This is a basic policy.
    'unsafe-eval' might be needed by some parts of Decap or its dependencies (like js-yaml in some modes).
    'unsafe-inline' for inline styles if Decap/React uses them.
    unpkg.com for loading modules.
    api.github.com and raw.githubusercontent.com for GitHub backend.
    your-github-pages-domain.github.io for self.
  -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https://*;
                 connect-src 'self' https://api.github.com https://raw.githubusercontent.com;
                 font-src 'self' https://unpkg.com;">
</head>
<body>
  <div id="nc-root"></div> <!-- Decap CMS will mount here -->

  <script type="module">
    // Log function for consistent output
    const log = (level, ...args) => console[level]('[ESM Decap]', ...args);

    async function initDecap() {
      try {
        log('info', 'Starting Decap CMS ESM initialization...');

        // Import core Decap CMS, GitHub backend, and js-yaml
        log('info', 'Importing modules...');
        const [{ default: CMS }, { default: GitHubBackend }, { default: yaml }] = await Promise.all([
          import('https://unpkg.com/decap-cms-core@^3.1.3/dist/decap-cms-core.js'), // Or latest stable 3.x
          import('https://unpkg.com/decap-cms-backend-github@^3.0.4/dist/decap-cms-backend-github.js'), // Or latest stable 3.x
          import('https://unpkg.com/js-yaml@^4.1.0/dist/js-yaml.mjs')
        ]);
        log('info', 'Modules imported successfully.');

        // Register the GitHub backend
        CMS.registerBackend('github', GitHubBackend);
        log('info', 'GitHub backend registered.');

        // Fetch and parse config.yml
        log('info', 'Fetching /admin/config.yml...');
        const response = await fetch('/admin/config.yml?v=' + new Date().getTime()); // Cache bust
        if (!response.ok) {
          throw new Error(`Failed to fetch config.yml: ${response.statusText} (status: ${response.status})`);
        }
        const configYAML = await response.text();
        log('info', 'Successfully fetched config.yml.');

        const config = yaml.load(configYAML);
        log('info', 'Parsed config.yml:', JSON.parse(JSON.stringify(config)));

        // --- Ensure backend is correctly configured for GitHub ---
        if (!config.backend) {
          log('warn', 'Backend section missing in config.yml. Creating minimal GitHub backend.');
          config.backend = {};
        }
        log('info', 'Forcing backend settings for direct GitHub auth.');
        config.backend.name = 'github';
        config.backend.auth_type = 'github'; // Explicitly set for clarity
        delete config.backend.site_domain;   // Remove any Netlify-specific settings

        // Crucially, repo and branch must be in your config.yml
        if (!config.backend.repo || !config.backend.branch) {
          log('error', 'CRITICAL: backend.repo or backend.branch is missing in your config.yml. Decap CMS will fail.');
          // You might want to throw an error here or display it to the user.
          // For now, logging error and letting it proceed to see Decap's behavior.
        }
        // --- End backend forcing ---

        log('info', 'Final config object being passed to CMS.init:', JSON.parse(JSON.stringify(config)));

        // Initialize Decap CMS with the configuration
        CMS.init(config);
        log('info', 'CMS.init(config) has been called.');

      } catch (error) {
        log('error', 'Error during Decap CMS ESM initialization:', error);
        const root = document.getElementById('nc-root');
        if (root) {
          root.innerHTML = `<div style="padding: 20px; color: red;">
                              <h2>Decap CMS Initialization Error</h2>
                              <p>There was an error setting up the Content Management System.</p>
                              <p><strong>Error:</strong> ${error.message}</p>
                              <p>Please check the browser console for more details.</p>
                            </div>`;
        }
      }
    }

    // Run the initialization
    // Ensure DOM is ready, though with type="module" scripts are deferred by default.
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDecap);
    } else {
      initDecap();
    }
  </script>
</body>
</html>