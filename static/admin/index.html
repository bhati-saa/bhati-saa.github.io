<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>

  <!-- SCRIPT 1: Interceptor and Manual Init -->
  <script>
    let cmsObjectObserved = false;
    let actualCMSInit = null;
    let cmsInstanceRef = null;
    let manuallyLoadedConfig = null; // To store our fetched and parsed config

    // Try to intercept the CMS object
    if (typeof window.CMS === 'undefined') {
      Object.defineProperty(window, 'CMS', {
        configurable: true,
        enumerable: true,
        get() { return this._CMS; },
        set(cmsInstance) {
          this._CMS = cmsInstance;
          cmsInstanceRef = cmsInstance;
          if (cmsInstance && cmsInstance.init && !cmsObjectObserved) {
            cmsObjectObserved = true;
            console.log('CMS object intercepted via setter:', cmsInstance);
            actualCMSInit = cmsInstance.init;
            cmsInstance.init = function(config) { // Patched init
              console.log('[INTERCEPTED VIA SETTER] CMS.init CALLED. Config received by Decap:', JSON.parse(JSON.stringify(config || {})));

              let configToUse = manuallyLoadedConfig; // Prioritize our manually loaded config

              if (!configToUse && config && Object.keys(config).length > 0) {
                // If Decap somehow got a non-empty config, and we failed to load ours, maybe use Decap's
                console.log("Using config provided by Decap's init call as manual load failed or was empty.");
                configToUse = config;
              } else if (!configToUse) {
                // If both are empty/null, this is bad. Log and let it proceed with empty.
                console.error("Manually loaded config is null/empty, and Decap provided an empty config. Problems likely.");
                configToUse = {}; // or config
              }

              if (configToUse && configToUse.backend) {
                 console.log('Ensuring backend.auth_type is github and no site_domain in configToUse.');
                 configToUse.backend.auth_type = 'github'; // Force it
                 delete configToUse.backend.site_domain;   // Remove it
                 // delete configToUse.backend.base_url;    // Remove if you want to ensure GitHub API default
                 console.log('[INTERCEPTED VIA SETTER] CMS.init - Using this config:', JSON.parse(JSON.stringify(configToUse)));
              } else if (configToUse) {
                console.warn("configToUse does not have a backend property. This is likely an issue.", JSON.parse(JSON.stringify(configToUse)));
              } else {
                console.error("configToUse is undefined or null before calling actualCMSInit.");
              }

              return actualCMSInit.call(this, configToUse); // Call original with OUR config
            };
            // Now that CMS object is available and init is patched, load our config
            loadConfigAndThenSignalCmsInit(); // Renamed function
          }
        }
      });
    }

    async function loadConfigAndThenSignalCmsInit() {
      if (!cmsInstanceRef) { // Check cmsInstanceRef directly
        console.warn("loadConfigAndThenSignalCmsInit called but CMS instance not ready.");
        setTimeout(loadConfigAndThenSignalCmsInit, 100);
        return;
      }

      try {
        console.log("Attempting to fetch /admin/config.yml for manual load.");
        const response = await fetch('/admin/config.yml?v=' + new Date().getTime()); // Cache bust config.yml fetch
        if (!response.ok) {
          throw new Error(`Failed to fetch config.yml: ${response.statusText}`);
        }
        const configYAML = await response.text();
        console.log("Successfully fetched config.yml content for manual load.");

        // We need a YAML parser. Decap CMS bundles js-yaml.
        if (window.jsyaml) {
            manuallyLoadedConfig = window.jsyaml.load(configYAML);
            console.log("Parsed config.yml with window.jsyaml for manual use:", JSON.parse(JSON.stringify(manuallyLoadedConfig)));
        } else {
            console.error("window.jsyaml not found! Cannot parse config.yml. This is a critical issue for manual config loading.");
            // If jsyaml is not available, we cannot proceed with a parsed config.
            // Decap CMS will likely fail badly.
            // One option is to try and load js-yaml explicitly:
            // const script = document.createElement('script');
            // script.src = 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js';
            // script.onload = () => { manuallyLoadedConfig = window.jsyaml.load(configYAML); /* then call init */ };
            // document.head.appendChild(script);
            // For now, we'll just set it to null and our patched init will log the problem.
            manuallyLoadedConfig = null;
        }

        // IMPORTANT: We DO NOT call cmsInstanceRef.init() here anymore.
        // Decap's own auto-initialization will call our patched cmsInstanceRef.init.
        // Our patch will then use `manuallyLoadedConfig`.
        // If Decap's auto-init doesn't happen for some reason after this,
        // we might need to call cmsInstanceRef.init() here as a last resort.
        console.log("Manual config loaded. Waiting for Decap's auto-init to call our patched version.");

      } catch (error) {
        console.error("Error in loadConfigAndThenSignalCmsInit:", error);
        manuallyLoadedConfig = null; // Ensure it's null on error
      }
    }

    // Fallback just to log if CMS object wasn't caught by setter by DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      if (cmsInstanceRef && actualCMSInit) {
        console.log("DOMContentLoaded: CMS object was intercepted, init was patched. Manual config load should have been triggered.");
      } else if (window.CMS) {
        console.warn("DOMContentLoaded: window.CMS exists, but interception logic might have issues or ran too late.");
      } else {
        console.log("DOMContentLoaded: CMS object not yet available via fallback.");
      }
    });

  </script>

  <!-- SCRIPT 2: Load Decap CMS -->
  <script defer src="https://unpkg.com/decap-cms@^3.1.0/dist/decap-cms.js?v=debug5"></script>
  <!-- Cache buster incremented -->
</head>
<body>
</body>
</html>