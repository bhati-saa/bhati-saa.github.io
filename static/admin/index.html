<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; connect-src 'self' https://api.github.com https://raw.githubusercontent.com;">
  <!-- Added unsafe-eval for js-yaml if it uses it, and connect-src for GitHub API -->
  <title>Content Manager</title>
</head>
<body>
  <div id="nc-root"></div> <!-- Decap CMS often mounts here with ESM -->
  <script type="module">
    // Import necessary parts from Decap CMS ESM bundles
    // js-yaml should be available through these core imports or as a peer.
    import CMS, { init } from 'https://unpkg.com/decap-cms@^3.1.0/dist/decap-cms.core.js';
    import yaml from 'https://unpkg.com/js-yaml@^4.1.0/dist/js-yaml.mjs'; // Explicitly import js-yaml
    // You might also need to import specific backends if not using the full 'decap-cms-app.js'
    // For example, if decap-cms.core.js doesn't auto-register GitHub backend:
    // import githubBackend from 'https://unpkg.com/decap-cms-backend-github@^3.0.0/dist/decap-cms-backend-github.mjs';
    // CMS.registerBackend('github', githubBackend);

    let manuallyLoadedConfig = null;

    async function loadAndInit() {
      try {
        console.log("ESM: Attempting to fetch /admin/config.yml");
        const response = await fetch('/admin/config.yml?v=' + new Date().getTime());
        if (!response.ok) throw new Error(`Failed to fetch config.yml: ${response.statusText}`);
        const configYAML = await response.text();
        console.log("ESM: Successfully fetched config.yml content.");

        manuallyLoadedConfig = yaml.load(configYAML); // Use imported yaml
        console.log("ESM: Parsed config.yml:", JSON.parse(JSON.stringify(manuallyLoadedConfig)));

        if (manuallyLoadedConfig && manuallyLoadedConfig.backend) {
          console.log('ESM: Forcing backend.auth_type to github and removing site_domain.');
          manuallyLoadedConfig.backend.auth_type = 'github';
          delete manuallyLoadedConfig.backend.site_domain;
          console.log('ESM: Using this config for CMS.init:', JSON.parse(JSON.stringify(manuallyLoadedConfig)));
        } else {
          console.error("ESM: Manually loaded config is invalid or missing backend.");
          // Fallback to an empty config or throw error to prevent init
          manuallyLoadedConfig = {};
        }

        // Initialize Decap CMS with our loaded and modified config
        // The 'init' function imported from decap-cms.core.js should be used.
        // It might be CMS.init() or just init() depending on how it's exported.
        // Let's assume it's on the CMS object for now.
        if (CMS && CMS.init) {
            CMS.init(manuallyLoadedConfig);
        } else if (typeof init === 'function') {
            init(manuallyLoadedConfig); // If init is a direct export
        } else {
            console.error("ESM: CMS.init or init function not found!");
        }

      } catch (error) {
        console.error("ESM: Error in loadAndInit:", error);
        // Render an error message to the user
        const root = document.getElementById('nc-root');
        if (root) root.innerHTML = `<p>Error loading CMS: ${error.message}. Check console.</p>`;
      }
    }

    // Ensure the DOM is ready before trying to mount Decap CMS
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndInit);
    } else {
      loadAndInit();
    }
  </script>
</body>
</html>