<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>

  <!-- SCRIPT 1: Interceptor and Manual Init -->
  <script>
    let cmsObjectObserved = false;
    let actualCMSInit = null;
    let cmsInstanceRef = null;
    let manuallyLoadedConfig = null;

    function loadScript(src) { /* ... same as before ... */ }
    // Copy the loadScript function from the previous full code block here

    // Try to intercept the CMS object
    if (typeof window.CMS === 'undefined') {
      Object.defineProperty(window, 'CMS', {
        configurable: true,
        enumerable: true,
        get() { return this._CMS; },
        set(cmsInstance) {
          this._CMS = cmsInstance;
          cmsInstanceRef = cmsInstance;
          if (cmsInstance && cmsInstance.init && !cmsObjectObserved) {
            cmsObjectObserved = true;
            console.log('CMS object intercepted via setter:', cmsInstance);
            actualCMSInit = cmsInstance.init;
            cmsInstance.init = function(config) { // THIS IS OUR MAIN PATCHED INIT
              console.log('[MAIN PATCHED INIT] CMS.init CALLED. Config received by Decap:', JSON.parse(JSON.stringify(config || {})));

              let configToUse = manuallyLoadedConfig;

              if (!configToUse && config && Object.keys(config).length > 0) {
                console.log("Using config provided by Decap's init call as manual load failed or was empty.");
                configToUse = config;
              } else if (!configToUse) {
                console.error("Manually loaded config is null/empty, and Decap provided an empty config. Problems likely.");
                configToUse = {};
              }

              if (configToUse && typeof configToUse.backend !== 'undefined') {
                 console.log('Forcing backend.auth_type to github and removing site_domain in configToUse.');
                 if (!configToUse.backend) configToUse.backend = {};
                 configToUse.backend.auth_type = 'github';
                 delete configToUse.backend.site_domain;
                 console.log('[MAIN PATCHED INIT] CMS.init - Modified config before use:', JSON.parse(JSON.stringify(configToUse)));
              } else if (configToUse) {
                console.warn("configToUse does not have a backend property or it's null.", JSON.parse(JSON.stringify(configToUse)));
                 if (!configToUse.backend) {
                    console.log("Backend property missing, attempting to create a minimal one.");
                    configToUse.backend = { name: 'github', auth_type: 'github' };
                 }
              } else {
                console.error("configToUse is undefined or null before calling actualCMSInit.");
              }

              console.log('[MAIN PATCHED INIT] CMS.init - Calling original init with FINAL config:', JSON.parse(JSON.stringify(configToUse || {})));
              return actualCMSInit.call(this, configToUse);
            };
            loadConfigAndPrepareOrCallCmsInit(); // Changed name
          }
        }
      });
    }

    async function loadConfigAndPrepareOrCallCmsInit() {
      if (!cmsInstanceRef) { /* ... same as before ... */ }
      // Copy the initial part of this function (delay, fetch, js-yaml load) from the previous full code block

      // --- MODIFIED PART ---
      // ... (after manuallyLoadedConfig is set from js-yaml)

      console.log("Manual config loaded. Waiting a short moment for Decap's auto-init to call our patched version.");

      let decapAutoInitCalledOurPatch = false;
      const mainPatchedInit = cmsInstanceRef.init; // This is our main patch

      // Temporarily re-patch to detect if Decap calls our main patch
      cmsInstanceRef.init = function(config) {
          decapAutoInitCalledOurPatch = true;
          console.log("[TEMP RE-PATCH DETECTOR] Decap's auto-init called our (main) patched init.");
          return mainPatchedInit.call(this, config); // Call the 'main' patched init
      };

      await new Promise(resolve => setTimeout(resolve, 500)); // Wait for Decap's auto-init

      cmsInstanceRef.init = mainPatchedInit; // Restore our main patch

      if (!decapAutoInitCalledOurPatch) {
          console.warn("Decap's auto-init did NOT call our patched init. Attempting to call it manually NOW with our loaded config.");
          if (manuallyLoadedConfig) {
              console.log("Manually calling our main patched init with:", JSON.parse(JSON.stringify(manuallyLoadedConfig)));
              mainPatchedInit.call(cmsInstanceRef, manuallyLoadedConfig); // MANUALLY CALL OUR MAIN PATCHED INIT
          } else {
              console.error("Cannot manually call init: manuallyLoadedConfig is null. Decap will likely fail or use defaults.");
              mainPatchedInit.call(cmsInstanceRef, {}); // Call with empty to see what happens
          }
      } else {
          console.log("Decap's auto-init successfully called our patched init. No further manual call by us needed.");
      }
      // --- END MODIFIED PART ---
    }
    // Fallback log: document.addEventListener('DOMContentLoaded', ...) same as before
    // Make sure to copy the full `loadScript` and `loadConfigAndPrepareOrCallCmsInit` (with fetch and js-yaml parts) and `DOMContentLoaded` listener from the previous full HTML.
  </script>

  <script defer src="https://unpkg.com/decap-cms@^3.1.0/dist/decap-cms.js?v=debug7"></script>
</head>
<body></body>
</html>