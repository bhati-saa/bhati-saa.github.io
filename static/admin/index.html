<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com;
                 style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
                 img-src 'self' data: https:;
                 connect-src 'self' https://api.github.com https://raw.githubusercontent.com https://cdnjs.cloudflare.com https://unpkg.com;
                 font-src 'self' https://unpkg.com https://fonts.gstatic.com;">
</head>
<body>
  <div id="nc-root"></div>

  <script type="module">
    const log = (level, ...args) => console[level]('[ESM Decap App]', ...args);

    async function initDecap() {
      try {
        log('info', 'Starting Decap CMS App initialization...');
        log('info', 'Pre-loading React, ReactDOM, and PropTypes globally via dynamic import()...');

        const [ReactModule, ReactDOMModule, PropTypesModule] = await Promise.all([
          import('https://unpkg.com/react@^17.0.2/umd/react.production.min.js'),
          import('https://unpkg.com/react-dom@^17.0.2/umd/react-dom.production.min.js'),
          import('https://unpkg.com/prop-types@^15.8.1/prop-types.min.js')
        ]);

        window.React = ReactModule.default || window.React || ReactModule;
        window.ReactDOM = ReactDOMModule.default || window.ReactDOM || ReactDOMModule;
        window.PropTypes = PropTypesModule.default || window.PropTypes || PropTypesModule;

        log('info', 'React, ReactDOM, and PropTypes should now be globally available.');
        if (!(window.React && typeof window.React.createContext === 'function')) {
          log('error', 'FAILURE: window.React.createContext is NOT a function or window.React is wrong.');
          throw new Error("React (or React.createContext) was not loaded correctly onto the window object.");
        }
        log('info', 'SUCCESS: window.React.createContext is a function.');
        if (!window.PropTypes) { log('warn', 'window.PropTypes is not available.'); }
        else { log('info', 'SUCCESS: window.PropTypes is available.'); }


        log('info', 'Importing Decap CMS App and js-yaml...');
        const [DecapCmsApp_RawImport, JsYaml_RawImport] = await Promise.all([
          import('https://unpkg.com/decap-cms-app@^3/dist/decap-cms-app.js'),
          import('https://unpkg.com/js-yaml@^4/dist/js-yaml.mjs') // This is an .mjs ES module
        ]);

        log('info', 'Raw import for DecapCmsApp:', DecapCmsApp_RawImport);
        log('info', 'Raw import for JsYaml:', JsYaml_RawImport);

        let CMS = DecapCmsApp_RawImport.default; // Attempt 1: from .default (common for UMD/CJS)
        let yaml = JsYaml_RawImport.default;   // Attempt 1: from .default (standard for ES modules like js-yaml.mjs)

        log('info', 'Attempt 1: CMS from DecapCmsApp_RawImport.default:', CMS);
        log('info', 'Attempt 1: yaml from JsYaml_RawImport.default:', yaml);

        // Check if Attempt 1 for CMS was successful, if not, try the raw import itself
        if (!(CMS && typeof CMS.init === 'function')) {
          log('warn', 'CMS.init not found on .default of DecapCmsApp_RawImport. Trying raw import itself as CMS object.');
          CMS = DecapCmsApp_RawImport; // Attempt 2: raw import itself might be the CMS class
          log('info', 'Attempt 2: CMS from raw DecapCmsApp_RawImport:', CMS);
        }

        // js-yaml.mjs is an ES module, so its .default should be correct.
        // This check is more for completeness or unexpected issues.
        if (!(yaml && typeof yaml.load === 'function')) {
            log('warn', 'yaml.load not found on .default of JsYaml_RawImport. Trying raw import as yaml object.');
            yaml = JsYaml_RawImport; // Attempt 2 for yaml
            log('info', 'Attempt 2: yaml from raw JsYaml_RawImport:', yaml);
        }

        // Final verification before proceeding
        if (!(CMS && typeof CMS.init === 'function')) {
          log('error', 'FATAL: CMS.init function still not found after trying .default and raw import for Decap CMS.');
          log('info', 'Details: DecapCmsApp_RawImport:', DecapCmsApp_RawImport);
          if (DecapCmsApp_RawImport) log('info', 'Keys in DecapCmsApp_RawImport:', Object.keys(DecapCmsApp_RawImport));
          if (DecapCmsApp_RawImport && DecapCmsApp_RawImport.default) log('info', 'Keys in DecapCmsApp_RawImport.default:', Object.keys(DecapCmsApp_RawImport.default));
          throw new Error("CMS.init function could not be resolved from decap-cms-app import.");
        }
         log('info', 'SUCCESS: CMS.init function found.');

        if (!(yaml && typeof yaml.load === 'function')) {
          log('error', 'FATAL: yaml.load function still not found after trying .default and raw import for js-yaml.');
          log('info', 'Details: JsYaml_RawImport:', JsYaml_RawImport);
          if (JsYaml_RawImport) log('info', 'Keys in JsYaml_RawImport:', Object.keys(JsYaml_RawImport));
          if (JsYaml_RawImport && JsYaml_RawImport.default) log('info', 'Keys in JsYaml_RawImport.default:', Object.keys(JsYaml_RawImport.default));
          throw new Error("yaml.load function could not be resolved from js-yaml import.");
        }
        log('info', 'SUCCESS: yaml.load function found.');
        log('info', 'Decap CMS App and js-yaml modules resolved successfully.');

        log('info', 'Fetching /admin/config.yml...');
        const configResponse = await fetch('/admin/config.yml?v=' + new Date().getTime());
        if (!configResponse.ok) {
          throw new Error(`Failed to fetch config.yml: ${configResponse.statusText} (status: ${configResponse.status})`);
        }
        const configYAML = await configResponse.text();
        log('info', 'Successfully fetched config.yml.');

        const loadedConfig = yaml.load(configYAML);
        log('info', 'Parsed config.yml:', JSON.parse(JSON.stringify(loadedConfig)));

        if (!loadedConfig.backend) {
          log('warn', 'Backend section missing in config.yml. Creating minimal GitHub backend config.');
          loadedConfig.backend = {};
        }
        log('info', 'Forcing backend settings for direct GitHub auth in the loaded config.');
        loadedConfig.backend.name = 'github';
        loadedConfig.backend.auth_type = 'github';
        delete loadedConfig.backend.site_domain;

        if (!loadedConfig.backend.repo || !loadedConfig.backend.branch) {
          log('error', 'CRITICAL FAILURE: `backend.repo` or `backend.branch` is missing in your loaded config.yml.');
          const rootEl = document.getElementById('nc-root');
          if (rootEl) {
            rootEl.innerHTML = `<div style="padding: 20px; color: red;"><h2>Configuration Error</h2><p>The <code>backend.repo</code> or <code>backend.branch</code> is missing in your <code>/admin/config.yml</code>. Please correct this and try again.</p></div>`;
          }
          return;
        }
        log('info', `Using backend repo: ${loadedConfig.backend.repo}, branch: ${loadedConfig.backend.branch}`);

        log('info', 'Final config object being passed to CMS.init:', JSON.parse(JSON.stringify(loadedConfig)));

        CMS.init({ config: loadedConfig });
        log('info', 'CMS.init({ config: loadedConfig }) has been called.');

      } catch (error) {
        log('error', 'Error during Decap CMS App initialization:', error);
        const root = document.getElementById('nc-root');
        if (root) {
          root.innerHTML = `<div style="padding: 20px; color: red; font-family: sans-serif;">
                              <h2>Decap CMS Initialization Error</h2>
                              <p><strong>Details:</strong> ${error.message}</p>
                              <p>Please open the browser console (F12) for more technical details.</p>
                            </div>`;
        }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDecap);
    } else {
      initDecap();
    }
  </script>
</body>
</html>